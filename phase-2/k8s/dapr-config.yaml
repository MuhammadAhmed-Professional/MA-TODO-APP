# Dapr Configuration for Todo Application
#
# This configuration sets up Dapr sidecar behavior including:
# - Pub/sub components (Kafka)
# - Service mesh settings
# - Tracing and metrics
#
# Apply with: kubectl apply -f dapr-config.yaml
apiVersion: dapr.io/v1alpha1
kind: Configuration
metadata:
  name: todo-app-config
  namespace: todo-app
  labels:
    app: todo-app
spec:
  # tracing:
  #   samplingRate: "1"
  #   zipkin:
  #     endpointAddress: "http://zipkin.default.svc.cluster.local:9411/api/v2/spans"
  # Metrics configuration
  metrics:
    enabled: true
    rules:
      - name: "todo-backend"
        endpoints:
          - name: "metrics"
            port: 9090
  # API logging for debugging
  apiLogging:
    enabled: true
    # Only log health endpoints and errors to reduce noise
    omitHealthChecks: false
  # Feature flags
  features:
    - name: ProxyProtocol
      enabled: false

---
# Kafka Pub/Sub Component for Dapr
#
# This component enables publish/subscribe messaging using Kafka.
# The backend can publish events (e.g., task created, task completed)
# and subscribe to topics for async processing.
#
# Prerequisites:
# - Kafka running in the cluster (e.g., via Strimzi or Helm chart)
# - Service: kafka.kafka.svc.cluster.local:9092
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: todo-pubsub
  namespace: todo-app
  labels:
    app: todo-app
    component: pubsub
spec:
  type: pubsub.kafka
  version: v1
  metadata:
    # Kafka broker address
    - name: brokers
      value: "kafka.kafka.svc.cluster.local:9092"
    # Consumer group for this application
    - name: consumerGroup
      value: "todo-app-consumers"
    # Client ID for Dapr
    - name: clientID
      value: "todo-backend-dapr"
    # Initial offset when no commit exists
    - name: initialOffset
      value: "newest"
    # Authentication (if required)
    # - name: sasl
    #   value: "plain"
    # - name: saslUsername
    #   secretKeyRef:
    #     name: kafka-secrets
    #     key: username
    # - name: saslPassword
    #   secretKeyRef:
    #     name: kafka-secrets
    #     key: password

---
# Redis State Store Component (Alternative to direct DB access)
#
# Provides caching and session storage capabilities.
# Useful for rate limiting, session management, and caching.
#
# Prerequisites:
# - Redis running in the cluster
# - Service: redis.default.svc.cluster.local:6379
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: todo-state
  namespace: todo-app
  labels:
    app: todo-app
    component: state
spec:
  type: state.redis
  version: v1
  metadata:
    - name: redisHost
      value: "redis.default.svc.cluster.local:6379"
    - name: redisPassword
      secretKeyRef:
        name: todo-app-secrets
        key: redis-password
      optional: true
    # Database index (0-15)
    - name: redisDB
      value: "0"
    # Key prefix for Dapr state
    - name: keyPrefix
      value: "todo"
  # Scopes limit this component to specific apps
  scopes:
    - todo-backend

---
# Example Topic Subscription Configuration
#
# This shows how to configure subscriptions to Kafka topics.
# The backend would subscribe to events for async processing.
apiVersion: dapr.io/v1alpha1
kind: Subscription
metadata:
  name: task-events-subscription
  namespace: todo-app
spec:
  topic: task-events
  route: /api/events/task
  pubsubname: todo-pubsub
  scopes:
    - todo-backend
  # Dead letter topic for failed messages
  deadLetterTopic: task-events-dlq

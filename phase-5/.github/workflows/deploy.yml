name: Production Deployment

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ================== BUILD AND PUSH IMAGES ==================
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service:
          - name: backend
            context: phase-5/backend
            dockerfile: phase-5/backend/Dockerfile
          - name: frontend
            context: phase-2/frontend
            dockerfile: phase-2/frontend/Dockerfile
          - name: notification-service
            context: phase-5/services/notification-service
            dockerfile: phase-5/services/notification-service/Dockerfile
          - name: recurring-task-service
            context: phase-5/services/recurring-task-service
            dockerfile: phase-5/services/recurring-task-service/Dockerfile

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}:${{ steps.version.outputs.VERSION }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service.name }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  # ================== DEPLOY TO CLOUD KUBERNETES ==================
  deploy:
    name: Deploy to Cloud Kubernetes
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://todo-app.muhammadahmed.dev

    steps:
      - uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubectl (Azure AKS)
        if: secrets.CLOUD_PROVIDER == 'azure'
        env:
          KUBECONFIG_DATA: ${{ secrets.PROD_KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config

      - name: Configure kubectl (GCP GKE)
        if: secrets.CLOUD_PROVIDER == 'gcp'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      - name: Get GKE credentials
        if: secrets.CLOUD_PROVIDER == 'gcp'
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ secrets.GKE_CLUSTER_NAME }}
          location: ${{ secrets.GKE_LOCATION }}

      - name: Configure kubectl (Oracle OKE)
        if: secrets.CLOUD_PROVIDER == 'oracle'
        env:
          KUBECONFIG_DATA: ${{ secrets.PROD_KUBECONFIG }}
        run: |
          mkdir -p $HOME/.kube
          echo "$KUBECONFIG_DATA" | base64 -d > $HOME/.kube/config

      - name: Install Strimzi Kafka Operator
        run: |
          kubectl apply -f 'https://strimzi.io/install/latest?namespace=todo-app' -n todo-app || true

      - name: Deploy Kafka cluster
        run: |
          kubectl apply -f phase-5/k8s/cloud/kafka-strimzi.yaml
          kubectl wait kafka/kafka --for=condition=Ready --timeout=600s -n todo-app

      - name: Deploy Dapr components
        run: |
          kubectl apply -f phase-5/dapr/components/ -n todo-app
          kubectl apply -f phase-5/dapr/config.yaml

      - name: Deploy application
        run: |
          # Apply all Kubernetes manifests
          kubectl apply -f phase-5/k8s/cloud/namespace.yaml
          kubectl apply -f phase-5/k8s/cloud/backend-deployment.yaml
          kubectl apply -f phase-5/k8s/cloud/frontend-deployment.yaml
          kubectl apply -f phase-5/k8s/cloud/notification-service-deployment.yaml
          kubectl apply -f phase-5/k8s/cloud/recurring-task-service-deployment.yaml
          kubectl apply -f phase-5/k8s/cloud/services.yaml
          kubectl apply -f phase-5/k8s/cloud/hpa.yaml
          kubectl apply -f phase-5/k8s/cloud/ingress.yaml

      - name: Wait for deployments
        run: |
          kubectl rollout status deployment/todo-backend -n todo-app --timeout=5m
          kubectl rollout status deployment/todo-frontend -n todo-app --timeout=5m
          kubectl rollout status deployment/notification-service -n todo-app --timeout=5m
          kubectl rollout status deployment/recurring-task-service -n todo-app --timeout=5m

      - name: Verify deployment
        run: |
          echo "=== Pods ==="
          kubectl get pods -n todo-app
          echo ""
          echo "=== Services ==="
          kubectl get services -n todo-app
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n todo-app
          echo ""
          echo "=== HPA ==="
          kubectl get hpa -n todo-app

      - name: Run smoke tests
        run: |
          # Wait for ingress to be ready
          sleep 30

          # Test frontend
          curl -f https://todo-app.muhammadahmed.dev/health || exit 1

          # Test backend API
          curl -f https://api.todo-app.muhammadahmed.dev/health || exit 1

          echo "âœ… Smoke tests passed!"

  # ================== NOTIFY DEPLOYMENT ==================
  notify:
    name: Notify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    steps:
      - name: Notify Slack
        if: secrets.SLACK_WEBHOOK_URL != ''
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            Deployment to ${{ github.event.inputs.environment || 'production' }}
            Status: ${{ job.status }}
            Version: ${{ github.event.release.tag_name || 'latest' }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Discord
        if: secrets.DISCORD_WEBHOOK_URL != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK_URL }}
          status: ${{ job.status }}
          title: "Deployment to ${{ github.event.inputs.environment || 'production' }}"
          description: "Version: ${{ github.event.release.tag_name || 'latest' }}"
